<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>aoi.js Admin Panel</title>
    <link rel="icon" href="/assets/raglogo.png" type="image/png" sizes="any" />
    <link rel="apple-touch-icon" href="/assets/raglogo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div class="max-w-6xl mx-auto p-4">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">Admin Panel</h1>
        <a href="/dashboard" class="text-sm text-brand-400 hover:underline">Back to Dashboard</a>
      </header>
      <div id="content" class="grid md:grid-cols-2 gap-6">
        <section class="bg-slate-900 rounded p-4">
          <h2 class="text-lg font-semibold mb-3">Users</h2>
          <ul id="usersList" class="space-y-2"></ul>
        </section>
        <section class="bg-slate-900 rounded p-4">
          <h2 class="text-lg font-semibold mb-3">User Keys</h2>
          <div id="userInfo" class="text-sm text-slate-300 mb-2">Select a user to view keys.</div>
          <ul id="keysList" class="space-y-2"></ul>
        </section>
      </div>
    </div>
    <script>
      async function ensureAdmin(){
        const me = await fetch('/me').then(r=>r.ok?r.json():null).catch(()=>null);
        if (!me) { location.href = '/dashboard'; return false; }
        const test = await fetch('/admin/users');
        if (test.status === 403) { location.href = '/dashboard'; return false; }
        return true;
      }

      async function loadUsers(){
        const res = await fetch('/admin/users');
        const users = res.ok ? await res.json() : [];
        const ul = document.getElementById('usersList');
        ul.innerHTML = '';
        users.forEach(u => {
          const li = document.createElement('li');
          li.className = 'flex items-center gap-3 rounded bg-slate-800 p-2 cursor-pointer hover:bg-slate-700';
          li.innerHTML = `<img src="${u.avatar||'https://placehold.co/48x48'}" class="w-10 h-10 rounded" alt="avatar" /><div class="flex-1"><div class="text-sm font-medium">${u.username||'(unknown)'} · ${u.email||''}</div><div class="text-xs text-slate-400">Keys: ${u.key_count} · Requests: ${u.request_total}</div></div>`;
          li.onclick = () => loadKeysForUser(u);
          ul.appendChild(li);
        });
      }

      async function loadKeysForUser(u){
        document.getElementById('userInfo').textContent = `Keys for ${u.username||u.id}`;
        const res = await fetch('/admin/users/'+u.id+'/keys');
        const keys = res.ok ? await res.json() : [];
        const ul = document.getElementById('keysList');
        ul.innerHTML = '';
        keys.forEach(k => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between rounded bg-slate-800 p-2';
          const left = document.createElement('div');
          left.className = 'text-xs';
          left.innerHTML = `<div class="font-mono">${k.name||'(unnamed)'} · ${new Date(k.created_at).toLocaleString()}</div><div class="text-slate-400">Last used: ${k.last_used_at?new Date(k.last_used_at).toLocaleString():'—'} · Requests: ${k.request_count}</div>`;
          const badge = document.createElement('span');
          badge.className = 'ml-2 inline-block text-[11px] px-2 py-1 rounded ' + (k.revoked ? 'bg-rose-700 text-rose-100' : 'bg-emerald-700 text-emerald-100');
          badge.textContent = k.revoked ? 'Revoked' : 'Active';
          const right = document.createElement('div');
          right.appendChild(badge);
          li.appendChild(left);
          li.appendChild(right);
          ul.appendChild(li);
        });
      }

      (async function init(){
        const ok = await ensureAdmin();
        if (!ok) return;
        await loadUsers();
      })();
    </script>
  </body>
  </html>
